import pygame as p,math,random,os,tempfile,threading,wave,struct
from math import sin as sn,cos as co,pi
rr=random.random;ru=random.uniform
PAL=[int(ru(0,256)),int(ru(0,256)),int(ru(0,256))]
CO=[rr()*6.28,rr()*6.28,rr()*6.28];SW1=ru(-0.3,0.3);SW2=ru(-0.3,0.3)
IMS=[];st=[]
def pc(v):return(v*PAL[0]//255,v*PAL[1]//255,v*PAL[2]//255)
def load_obj(path):
    # read a Wavefront OBJ and return vertices and faces
    vs=[];fs=[]
    f=open(path)
    for l in f:
        if l.startswith('v '):
            x,y,z=map(float,l.split()[1:]);vs.append((x,y,z))
        if l.startswith('f '):
            pts=[int(i.split('/')[0])-1 for i in l.split()[1:]];fs.append(tuple(pts))
    f.close()
    return vs,fs
def gen_assets():
    # generate textures and a simple cube OBJ in the 'd' directory
    d='d'
    os.makedirs(d,exist_ok=True)
    texs=[];objs=[]
    for i in range(4):
        fp=os.path.join(d,'tex'+str(i)+'.png')
        if not os.path.exists(fp):
            s=p.Surface((64,64))
            r1=ru(0,6.28);r2=ru(0,6.28)
            for x in range(32):
                for y in range(32):
                    v=int(128+127*sn(x*0.15+r1)+127*sn(y*0.15+r2))
                    v=max(0,min(255,v));col=(v,v//2,255-v)
                    s.set_at((x,y),col);
                    s.set_at((63-x,y),col);
                    s.set_at((x,63-y),col);
                    s.set_at((63-x,63-y),col)
            p.image.save(s,fp)
        texs.append(fp)
    # create simple cube if needed
    oc=os.path.join(d,'cube.obj')
    if not os.path.exists(oc):
        with open(oc,'w') as f:
            f.write('''v 1 1 1
v -1 1 1
v -1 -1 1
v 1 -1 1
v 1 1 -1
v -1 1 -1
v -1 -1 -1
v 1 -1 -1
f 1 2 3 4
f 5 6 7 8
f 1 5 8 4
f 2 6 7 3
f 1 2 6 5
f 4 3 7 8
''')
    objs.append(oc)
    return texs,objs
def sh(sf,t,vs,fs):
    # render a rotating 3D mesh onto a surface
    ang=t*0.6
    ca=co(ang);sa=sn(ang)
    cb=co(ang*0.3);sb=sn(ang*0.3)
    ps=[]
    sfactor=350*(1+0.3*sn(t*0.4))
    for vx,vy,vz in vs:
        x1=vx*ca-vz*sa
        z1=vx*sa+vz*ca
        y1=vy*cb-z1*sb
        z2=vy*sb+z1*cb
        sc=sfactor/(z2+3)
        ps.append((int(W/2+x1*sc),int(H/2+y1*sc),z2))
    sf.fill((0,0,0))
    for face in fs:
        z=sum(ps[i][2] for i in face)/len(face)
        col=int(max(0,min(255,200+z*40)))
        pg=[ps[i][:2] for i in face]
        p.draw.polygon(sf,(col,int(col*0.6),int(col*0.3)),pg)
def g():
    
    sr=22050
    bl=ru(1.8,2.4)
    rd=bl/16
    
    pn=3+int(rr()*5)
    major=[0,2,4,5,7,9,11]
    minor=[0,2,3,5,7,8,10]
    
    pgs=[[0,4,5,3],[0,5,3,4],[0,3,4,5],[0,5,2,6],[0,2,4,5],[0,3,5,7],[0,5,7,3],[0,4,7,5],[0,1,4,6],[0,5,8,11],[0,2,5,9],[0,3,6,8]]
    patterns=[]
    for _ in range(pn):
        base=24+int(rr()*36)
        sc=major if rr()<0.5 else minor
        cp=pgs[int(rr()*len(pgs))]
        chords=[]
        for ci in cp:
            r=base+sc[ci%len(sc)]
            t3=base+sc[(ci+2)%len(sc)]
            t5=base+sc[(ci+4)%len(sc)]
            chords.append((r,t3,t5))
        chd=[];mel=[];bas=[];dr=[]
        for r in range(64):
            b=r//16
            note_tuple=chords[b]
            chd.append(note_tuple)
            if r%4==0:
                mel.append(note_tuple[int(rr()*3)])
            else:
                mel.append(note_tuple[int(rr()*3)] if rr()<0.7 else 0)
            bas.append(base-12+sc[cp[b]%len(sc)] if r%8==0 else 0)
            if r%16==0:
                dr.append(1)
            elif r%16==8:
                dr.append(2)
            elif r%2==0:
                dr.append(3)
            else:
                dr.append(0)
        patterns.append((chd,mel,bas,dr))
    # order of patterns: repeat each pattern 2 or 4 times
    ord=[]
    for i in range(pn):
        rp=4 if rr()<0.3 else 2
        ord+=[i]*rp
    rows=[(idx,r) for idx in ord for r in range(64)]
    tot=len(rows)
    try:
        dd='d'
        os.makedirs(dd,exist_ok=True)
        fn=os.path.join(dd,'m'+str(int(rr()*1e9))+'.wav')
    except:
        fn=os.path.join(tempfile.gettempdir(),'m.wav')
    wv=wave.open(fn,'wb')
    wv.setnchannels(1)
    wv.setsampwidth(2)
    wv.setframerate(sr)
    total_samples=int(tot*rd*sr)
    fade_len=int(sr*3)
    for i in range(total_samples):
        t=i/sr
        ri=int(t/rd)
        ri=ri if ri<tot else tot-1
        pi,pr=rows[ri]
        chd,mel,bas,drp=patterns[pi]
        notes=chd[pr]
        mn=mel[pr]
        bn=bas[pr]
        drum=drp[pr]
        val=0
        for f in notes:
            val+=sn(2*pi*440*(2**((f-69)/12))*t)*0.15
        if mn:
            val+=sn(2*pi*440*(2**((mn-69)/12))*t)*0.3
        if bn:
            val+=sn(2*pi*440*(2**((bn-69)/12))*t)*0.25
        dt=t-(ri*rd)
        if drum==1:
            amp=1-dt/(rd*0.3) if dt<rd*0.3 else 0
            val+=sn(2*pi*60*t)*amp*0.5
        elif drum==2:
            amp=1-dt/(rd*0.2) if dt<rd*0.2 else 0
            val+=sn(2*pi*800*t)*amp*0.5
        elif drum==3:
            amp=1-dt/(rd*0.1) if dt<rd*0.1 else 0
            val+=sn(2*pi*3000*t)*amp*0.3
        if i<fade_len:
            val*=i/fade_len
        elif i>total_samples-fade_len:
            val*=(total_samples-i)/fade_len
        if val>1:
            val=1
        if val<-1:
            val=-1
        wv.writeframes(struct.pack('<h',int(val*32767)))
    wv.close()
    return fn
def parallax(sf,t):
    global offsets
    sf.fill((0,0,0))
    h=64
    for i,l in enumerate(layers):
        w=l.get_width()
        x=offsets[i]%w
        for pos in range(-w,W+w,w):
            sf.blit(l,(pos-x,i*H//len(layers)))
        offsets[i]+=speeds[i]
def sinus(sf,t):
    sf.fill((0,0,0))
    ln=len(text)
    scale=30
    for i,ch in enumerate(text):
        x=i*scale-sf.get_width()/2+(t*100)%(ln*scale)
        y=H*0.5+sn(i*0.3+t*0.8)*H*0.2
        if -scale<x<W:
            col=pc((i*8)%256)
            p.draw.circle(sf,col,(int(x),int(y)),int(scale*0.4))
def tunnel(sf,t):
    sf.fill((0,0,0))
    for i in range(40):
        z=(t*200+i*10)%800
        rad=int(600/(z+1))
        col=pc(int(255*i/40))
        if rad>0:
            p.draw.circle(sf,col,(W//2,H//2),rad,2)
def objfx(sf,t):
    if not OBJ_VERT:
        return
    ang=t*0.5
    ca=co(ang);sa=sn(ang)
    cb=co(ang*0.3);sb=sn(ang*0.3)
    pts=[]
    sfactor=350*(1+0.3*sn(t*0.4))
    for vx,vy,vz in OBJ_VERT:
        x1=vx*ca-vz*sa
        z1=vx*sa+vz*ca
        y1=vy*cb-z1*sb
        z2=vy*sb+z1*cb
        sc=sfactor/(z2+3)
        pts.append((int(W/2+x1*sc),int(H/2+y1*sc),z2))
    sf.fill((0,0,0))
    for f in OBJ_FACE:
        z=sum(pts[i][2] for i in f)/len(f)
        col=int(max(0,min(255,200+z*40)))
        p.draw.polygon(sf,(col,int(col*0.6),int(col*0.3)),[pts[i][:2] for i in f])
def bars(sf,t):
    sf.fill((0,0,0))
    sh=int((t*100)%40)
    for x in range(-sh,W,40):
        c=int(128+127*sn(t*0.5+x*0.05))
        p.draw.rect(sf,pc(c),(x,0,20,H))
def starfield(sf,t):
    sf.fill((0,0,0))
    for s in stars:
        x,y,z=s
        # move star toward viewer; reset if too close
        z-=5
        if z<=1:
            z=random.randint(200,800)
        s[2]=z
        k=200.0/float(z)
        xi=int(W/2+(x-W/2)*k)
        yi=int(H/2+(y-H/2)*k)
        col=pc(int(255*(1-z/800)))
        if 0<=xi<W and 0<=yi<H:
            p.draw.circle(sf,col,(xi,yi),2)

def lc(sf,t):
    for x in range(0,W,4):
        h=int(H*0.4+sn(x*0.01+t*0.3)*H*0.1+sn(x*0.05+t*0.4)*H*0.05)
        sky=(0,0,int(120+100*sn(t*0.5)))
        ground=(20,int(100+80*sn(t*0.3)),20)
        p.draw.line(sf,sky,(x,0),(x,h))
        p.draw.line(sf,ground,(x,h),(x,H))

def cp(sf,t):
    if IMS:
        idx=int((t*0.2)%len(IMS))
        surf=IMS[idx]
        R=p.transform.rotate(surf,t*10)
        Q=p.transform.smoothscale(R,(W,H))
        Q.set_alpha(140)
        sf.blit(Q,(0,0))

def spn2(sf,t):
    sf.fill((0,0,0))
    cx=int(W/2+sn(t*SW1)*W*0.2)
    cy=int(H/2+co(t*SW2)*H*0.2)
    R2=min(W,H)/2
    for i in range(60):
        ang=i*0.10472+t*0.5
        x=int(cx+co(ang)*R2)
        y=int(cy+sn(ang)*R2)
        c=int((sn(ang*4)+1)*127)
        p.draw.line(sf,pc(c),(cx,cy),(x,y),2)

def fld2(sf,t):
    sf.fill((0,0,0))
    for i in range(30):
        z=i/30
        y=int(H-((t*200)%H+z*H))
        c=int(255*(1-z))
        p.draw.line(sf,pc(c),(0,y),(W,y))

def bw2(sf,t):
    global CO
    sf.fill((0,0,0))
    br=int(128+127*sn(t*0.1+CO[0]))
    bg=int(128+127*sn(t*0.1+2+CO[1]))
    bb=int(128+127*sn(t*0.1+4+CO[2]))
    CO[0]+=0.001
    CO[1]+=0.0015
    CO[2]+=0.002
    for y in range(0,H,4):
        h=int(128*(sn(y*0.03+t*0.4)+1))
        p.draw.line(sf,(br*h//255,bg*h//255,bb*h//255),(0,y),(W,y))

def plasma(sf,t):
    sf.lock()
    for y in range(0,H,4):
        for x in range(0,W,4):
            v=int((sn(x*0.03+t)+sn(y*0.04+t*0.5)+sn((x+y)*0.02+t*0.3))*85+170)
            col=pc(v%256)
            p.draw.rect(sf,col,(x,y,4,4))
    sf.unlock()

def swirls(sf,sw,d,t):
    global st
    sf.fill((0,0,0))
    for s in st:
        x,y,vx,vy,r,sh=s
        if sw:
            dx=x-W/2;dy=y-H/2;vx+=sw*dy*d;vy-=sw*dx*d
        x+=vx*d;y+=vy*d;r+=d*50
        s[0]=x;s[1]=y;s[2]=vx;s[3]=vy;s[4]=r
    st=[s for s in st if 0<=s[0]<W and 0<=s[1]<H]
    cx=W/2+sn(t*0.2)*W*0.25;cy=H/2+co(t*0.17)*H*0.25
    for _ in range(5):
        a=rr()*2*pi;sp=ru(50,200);sh=int(rr()*3)
        st.append([cx,cy,co(a)*sp,sn(a)*sp,1,sh])
    for s in st:
        c=min(255,int(s[4]*10))
        rad=max(1,int(s[4]*0.05))
        if s[5]==0:p.draw.circle(sf,(c,c,c),(int(s[0]),int(s[1])),rad)
        elif s[5]==1:p.draw.rect(sf,(c,c,c),(int(s[0])-rad,int(s[1])-rad,rad*2,rad*2))

def swirl0(sf,t):swirls(sf,0,2,t)
def swirl1(sf,t):swirls(sf,SW1,2,t)
def swirl2(sf,t):swirls(sf,SW2,2,t)
DATA0=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672,673,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868,869,870,871,872,873,874,875,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893,894,895,896,897,898,899,900,901,902,903,904,905,906,907,908,909,910,911,912,913,914,915,916,917,918,919,920,921,922,923,924,925,926,927,928,929,930,931,932,933,934,935,936,937,938,939,940,941,942,943,944,945,946,947,948,949,950,951,952,953,954,955,956,957,958,959,960,961,962,963,964,965,966,967,968,969,970,971,972,973,974,975,976,977,978,979,980,981,982,983,984,985,986,987,988,989,990,991,992,993,994,995,996,997,998,999]
DATA1=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672,673,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868,869,870,871,872,873,874,875,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893,894,895,896,897,898,899,900,901,902,903,904,905,906,907,908,909,910,911,912,913,914,915,916,917,918,919,920,921,922,923,924,925,926,927,928,929,930,931,932,933,934,935,936,937,938,939,940,941,942,943,944,945,946,947,948,949,950,951,952,953,954,955,956,957,958,959,960,961,962,963,964,965,966,967,968,969,970,971,972,973,974,975,976,977,978,979,980,981,982,983,984,985,986,987,988,989,990,991,992,993,994,995,996,997,998,999]
DATA2=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672,673,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868,869,870,871,872,873,874,875,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893,894,895,896,897,898,899,900,901,902,903,904,905,906,907,908,909,910,911,912,913,914,915,916,917,918,919,920,921,922,923,924,925,926,927,928,929,930,931,932,933,934,935,936,937,938,939,940,941,942,943,944,945,946,947,948,949,950,951,952,953,954,955,956,957,958,959,960,961,962,963,964,965,966,967,968,969,970,971,972,973,974,975,976,977,978,979,980,981,982,983,984,985,986,987,988,989,990,991,992,993,994,995,996,997,998,999]
DATA3=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672,673,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868,869,870,871,872,873,874,875,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893,894,895,896,897,898,899,900,901,902,903,904,905,906,907,908,909,910,911,912,913,914,915,916,917,918,919,920,921,922,923,924,925,926,927,928,929,930,931,932,933,934,935,936,937,938,939,940,941,942,943,944,945,946,947,948,949,950,951,952,953,954,955,956,957,958,959,960,961,962,963,964,965,966,967,968,969,970,971,972,973,974,975,976,977,978,979,980,981,982,983,984,985,986,987,988,989,990,991,992,993,994,995,996,997,998,999]
DATA4=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512,513,514,515,516,517,518,519,520,521,522,523,524,525,526,527,528,529,530,531,532,533,534,535,536,537,538,539,540,541,542,543,544,545,546,547,548,549,550,551,552,553,554,555,556,557,558,559,560,561,562,563,564,565,566,567,568,569,570,571,572,573,574,575,576,577,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,596,597,598,599,600,601,602,603,604,605,606,607,608,609,610,611,612,613,614,615,616,617,618,619,620,621,622,623,624,625,626,627,628,629,630,631,632,633,634,635,636,637,638,639,640,641,642,643,644,645,646,647,648,649,650,651,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,672,673,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,715,716,717,718,719,720,721,722,723,724,725,726,727,728,729,730,731,732,733,734,735,736,737,738,739,740,741,742,743,744,745,746,747,748,749,750,751,752,753,754,755,756,757,758,759,760,761,762,763,764,765,766,767,768,769,770,771,772,773,774,775,776,777,778,779,780,781,782,783,784,785,786,787,788,789,790,791,792,793,794,795,796,797,798,799,800,801,802,803,804,805,806,807,808,809,810,811,812,813,814,815,816,817,818,819,820,821,822,823,824,825,826,827,828,829,830,831,832,833,834,835,836,837,838,839,840,841,842,843,844,845,846,847,848,849,850,851,852,853,854,855,856,857,858,859,860,861,862,863,864,865,866,867,868,869,870,871,872,873,874,875,876,877,878,879,880,881,882,883,884,885,886,887,888,889,890,891,892,893,894,895,896,897,898,899,900,901,902,903,904,905,906,907,908,909,910,911,912,913,914,915,916,917,918,919,920,921,922,923,924,925,926,927,928,929,930,931,932,933,934,935,936,937,938,939,940,941,942,943,944,945,946,947,948,949,950,951,952,953,954,955,956,957,958,959,960,961,962,963,964,965,966,967,968,969,970,971,972,973,974,975,976,977,978,979,980,981,982,983,984,985,986,987,988,989,990,991,992,993,994,995,996,997,998,999]
DATA5=DATA0
def noise_fx(sf,t):
    sf.fill((0,0,0))
    n=len(DATA0)
    for i in range(0,W,4):
        idx=(i+int(t*100))%n
        val=DATA0[idx]
        col=pc(val%256)
        p.draw.line(sf,col,(i,0),(i,H))
def update_palette():
    PAL[0]=random.randint(0,255)
    PAL[1]=random.randint(0,255)
    PAL[2]=random.randint(0,255)
def init():
    global W,H,layers,offsets,speeds,text,stars,OBJ_VERT,OBJ_FACE,tex_files,obj_files,CO,SW1,SW2,IMS,st
    p.init()
    p.mixer.init(22050,-16,1)
    info=p.display.Info()
    W,H=info.current_w,info.current_h
    # create a fullscreen display surface
    p.display.set_mode((W,H),p.FULLSCREEN)
    p.display.set_caption('scenedemo')
    p.mouse.set_visible(False)
    gen_assets()
    tex_files,obj_files=gen_assets()
    layers=[];offsets=[];speeds=[];stars=[]
    for fp in tex_files:
        m=p.image.load(fp)
        layers.append(p.transform.smoothscale(m,(W,int(H/len(tex_files)))))
        offsets.append(0)
        speeds.append(1+rr()*2)
    text='WELCOME TO THE DEMOSCENE! '*800
    CO=[rr()*6.28,rr()*6.28,rr()*6.28]
    SW1=ru(-0.3,0.3)
    SW2=ru(-0.3,0.3)
    IMS=[]
    for fp in tex_files:
        IMS.append(p.image.load(fp))
    st=[]
    for _ in range(200):
        stars.append([random.randint(0,W),random.randint(0,H),random.randint(1,800)])
    if obj_files:
        vs,fs=load_obj(obj_files[0])
        OBJ_VERT=vs;OBJ_FACE=fs
    else:
        OBJ_VERT=[];OBJ_FACE=[]
def main():
    init()
    
    try:
        p.font.init()
        f=p.font.Font(None,int(H*0.1))
        m=f.render('WAIT',True,(255,255,255))
        S=p.display.get_surface()
        S.fill((0,0,0))
        S.blit(m,(W//2-m.get_width()//2,H//2-m.get_height()//2))
        p.display.flip()
        p.time.wait(1000)
    except:
        pass
    u=p.Surface((W,H))
    v=p.Surface((W,H))
    clk=p.time.Clock()
    t=0
    idx=0
    next_idx=1
    fade=0
    fx=[parallax,sinus,tunnel,objfx,bars,starfield,lc,cp,spn2,fld2,bw2,swirl0,swirl1,swirl2,plasma]
    random.shuffle(fx)
    mp=g()
    next_mp=[None]
    def load_next():
        next_mp[0]=g()
    th=threading.Thread(target=load_next)
    th.start()
    try:
        p.mixer.music.load(mp)
        p.mixer.music.play(-1)
    except:
        pass
    c=0
    while True:
        for e in p.event.get():
            if e.type==p.QUIT or (e.type==p.KEYDOWN and e.key==p.K_ESCAPE):
                return
        fade+=0.01
        if fade>=1:
            fade=0
            idx=next_idx
            next_idx=(idx+1)%len(fx)
            update_palette()
        fx[idx](u,t)
        fx[next_idx](v,t)
        uw=u.copy()
        vw=v.copy()
        vw.set_alpha(int(fade*255))
        uw.set_alpha(int((1-fade)*255))
        S=p.display.get_surface()
        S.blit(uw,(0,0))
        S.blit(vw,(0,0))
        p.display.flip()
        t+=clk.tick(60)/1000
        c+=1
        if c%600==0:
            PAL[0]=random.randint(0,255)
            PAL[1]=random.randint(0,255)
            PAL[2]=random.randint(0,255)
        if not p.mixer.music.get_busy():
            if next_mp[0]:
                try:
                    p.mixer.music.load(next_mp[0])
                    p.mixer.music.play(-1)
                except:
                    pass
                th=threading.Thread(target=load_next)
                th.start()
    p.quit()

if __name__=='__main__':
    main()